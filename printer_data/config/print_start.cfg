[gcode_macro PRINT_START]
gcode:
  # ------------------------------------------
  # Extract parameters from the slicer
  # ------------------------------------------
  {% set target_bed = params.BED|default(0)|int %}
  {% set target_extruder = params.EXTRUDER|default(0)|int %}
  {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
  {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}

  # ------------------------------------------
  M140 S{target_bed}

  M190 S{target_bed}

  {% if target_extruder > 240 %}
  G4 S300                                        ; Only wait 5 minutes for ASA/ABS
  {% endif %}


  # Optional: Beacon (Contact mode) - Uncomment if using
  SET_GCODE_OFFSET Z=0                                 # Reset Z offset

  # Home the printer
  G28
  G90  # Absolute positioning

  # Optional: Bed Mesh (Part 1)
  BED_MESH_CLEAR

  # Heat hotend to 150Â°C for accurate Z-homing
  M109 S150

  # Optional: Beacon (Contact mode) - Uncomment if using
  G28 Z METHOD=CONTACT CALIBRATE=1

  # Optional: V2.4 - Quad Gantry Leveling
  QUAD_GANTRY_LEVEL
  G28 Z  # Re-home Z after QGL

  # Optional: Bed Mesh (Part 2)
  BED_MESH_CALIBRATE  ADAPTIVE=1 

  # Optional: Beacon (Contact mode) - Uncomment if using
  G28 Z METHOD=CONTACT CALIBRATE=0

  # ------------------------------------------
  # Move to center and heat up for printing
  # ------------------------------------------
  G1 X{x_wait} Y{y_wait} Z15 F9000  # Move to center of bed
  M107                              # Turn off part cooling fan

  M190 S{target_bed}               # Heat bed to slicer-provided temp
  M109 S{target_extruder}         # Heat hotend to slicer-provided temp

  # ------------------------------------------
  # Automatically enable Nevermore for high-temp filaments (ASA/ABS)
  # ------------------------------------------
  {% if target_extruder > 240 %}
  SET_FAN_SPEED FAN=Nevermore SPEED=0.8
  {% endif %}

  # Optional: Beacon (Contact mode) - Uncomment if using
  SET_GCODE_OFFSET Z=0.21  # Adjust Z offset for thermal expansion

  # ------------------------------------------
  # Prime line before starting the print
  # ------------------------------------------
  G0 X{x_wait - 50} Y4 F10000  # Move to prime line start
  G0 Z0.4                      # Set Z height
  G91                          # Relative mode
  G1 X100 E20 F1000            # Prime line
  G90                          # Back to absolute mode
