[gcode_macro PRINT_START]
description: "Start of print macro - handles heating, leveling, mesh, and primeline"
gcode:
  # ────────────────────────────────────────────────
  # 🧠 Extract parameters passed from slicer
  # ────────────────────────────────────────────────
  {% set target_bed = params.BED|default(0)|int %}
  {% set target_extruder = params.EXTRUDER|default(0)|int %}
  {% set x_wait = printer.toolhead.axis_maximum.x / 2 %}
  {% set y_wait = printer.toolhead.axis_maximum.y / 2 %}

  # ────────────────────────────────────────────────
  # 🛑 Cancel any slicer-initiated heating (just in case)
  # ────────────────────────────────────────────────
  M104 S0

  # ────────────────────────────────────────────────
  # 🌡️ Start heating the bed
  # ────────────────────────────────────────────────
  M140 S{target_bed}       ; Begin heating bed
  M190 S{target_bed}       ; Wait for bed to reach temp

  # 🧱 Optional: chamber soak for ASA/ABS
  {% if target_extruder > 240 %}
    G4 S300                 ; 5-minute soak for high-temp filaments
  {% endif %}

  # ────────────────────────────────────────────────
  # 🏠 Homing & Leveling
  # ────────────────────────────────────────────────
  SET_GCODE_OFFSET Z=0     ; Reset any Z offset

  G28                      ; Full XYZ homing
  G90                      ; Absolute positioning
  BED_MESH_CLEAR

  # 🔥 Heat nozzle to 150°C for safe probing
  M109 S150

  # Beacon or Probe Contact Homing (if applicable)
  G28 Z METHOD=CONTACT CALIBRATE=1

  # 🚧 Quad Gantry Level (V2.4)
  QUAD_GANTRY_LEVEL
  G28 Z                    ; Re-home Z after QGL

  # 📏 Bed Mesh (Adaptive)
  BED_MESH_CALIBRATE ADAPTIVE=1

  # Final Beacon Z-offset calibration (optional)
  G28 Z METHOD=CONTACT CALIBRATE=0

  # ────────────────────────────────────────────────
  # 🚀 Move to center and begin final heating
  # ────────────────────────────────────────────────
  G1 X{x_wait} Y{y_wait} Z15 F9000
  M107                      ; Ensure part cooling fan is off

  # 🔥 Final target temps for print
  M190 S{target_bed}       ; Ensure bed is still at target
  M109 S{target_extruder}  ; Heat hotend to print temp

  # 💨 Turn on Nevermore for high-temp filaments
  {% if target_extruder > 240 %}
    SET_FAN_SPEED FAN=Nevermore SPEED=0.8
  {% endif %}

  # 🛠 Adjust Z-offset for hot nozzle expansion (optional tweak)
  {% if target_extruder > 240 %}
  SET_GCODE_OFFSET Z=0.44  ; Higher offset for ASA/ABS
  {% else %}
  SET_GCODE_OFFSET Z=0.21  ; Standard offset for PLA/PETG
  {% endif %}


  # ────────────────────────────────────────────────
  # 🧵 Primeline
  # ────────────────────────────────────────────────
  G0 X{x_wait - 50} Y4 F10000
  G0 Z0.4
  G91                      ; Relative positioning
  G1 X100 E20 F1000        ; Draw prime line
  G90                      ; Back to absolute mode
